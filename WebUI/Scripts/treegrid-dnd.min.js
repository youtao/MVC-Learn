(function(n){n.extend(n.fn.treegrid.defaults,{dropAccept:"tr[node-id]",onBeforeDrag:function(){},onStartDrag:function(){},onStopDrag:function(){},onDragEnter:function(){},onDragOver:function(){},onDragLeave:function(){},onBeforeDrop:function(){},onDrop:function(){}});n.extend(n.fn.treegrid.methods,{enableDnd:function(t,i){return n("#treegrid-dnd-style").length||n("head").append('<style id="treegrid-dnd-style">.treegrid-row-top td{border-top:1px solid red}.treegrid-row-bottom td{border-bottom:1px solid red}.treegrid-row-append .tree-title{border:1px solid red}<\/style>'),t.each(function(){function h(t,i){var r=n(t).draggable("proxy").find("span.tree-dnd-icon");r.removeClass("tree-dnd-yes tree-dnd-no").addClass(i?"tree-dnd-yes":"tree-dnd-no")}function f(t){var i=o(t),r=n(t).attr("node-id");return n(i).treegrid("find",r)}function o(t){return n(t).closest("div.datagrid-view").children("table")[0]}function v(t){var i=n(t).droppable("options");return i.disabled||i.accept=="no-accept"?!1:!0}function y(n,i){var u=i?t.dropAccept:"no-accept",f=t.finder.getTr(r,n);f.droppable({accept:u});f.next("tr.treegrid-tr-tree").find("tr[node-id]").droppable({accept:u})}var r=this,u=n.data(this,"treegrid"),s,t,l,c,e,a;if(u.disabledNodes||(u.disabledNodes=[]),s=n(this),t=u.options,i)for(e=t.finder.getTr(r,i),l=s.treegrid("getChildren",i),c=0;c<l.length;c++)e=e.add(t.finder.getTr(r,l[c][t.idField]));else e=s.treegrid("getPanel").find("tr[node-id]");e.draggable({disabled:!1,revert:!0,cursor:"pointer",proxy:function(i){var u=s.treegrid("find",n(i).attr("node-id")),r=n('<div class="tree-node-proxy"><\/div>').appendTo("body");return r.html('<span class="tree-dnd-icon tree-dnd-no">&nbsp;<\/span>'+u[t.treeField]),r.hide(),r},deltaX:15,deltaY:15,onBeforeDrag:function(i){return t.onBeforeDrag.call(r,f(this))==!1?!1:n(i.target).hasClass("tree-hit")||n(i.target).parent().hasClass("datagrid-cell-check")?!1:i.which!=1?!1:void 0},onStartDrag:function(){n(this).draggable("proxy").css({left:-1e4,top:-1e4});var i=f(this);u.draggingNodeId=i[t.idField];y(u.draggingNodeId,!1);t.onStartDrag.call(r,i)},onDrag:function(i){var f=i.pageX,e=i.pageY,o=i.data.startX,s=i.data.startY,c=Math.sqrt((f-o)*(f-o)+(e-s)*(e-s)),h,u;c>3&&(n(this).draggable("proxy").show(),h=t.finder.getTr(r,n(this).attr("node-id")),u=h.find("span.tree-title"),i.data.startX=u.offset().left,i.data.startY=u.offset().top,i.data.offsetWidth=0,i.data.offsetHeight=0);this.pageY=i.pageY},onStopDrag:function(){var n,i,f;for(y(u.draggingNodeId,!0),n=0;n<u.disabledNodes.length;n++)i=t.finder.getTr(r,u.disabledNodes[n]),i.droppable("enable");u.disabledNodes=[];f=s.treegrid("find",u.draggingNodeId);t.onStopDrag.call(r,f)}});a=n(r).data("datagrid").dc.view;a.add(e).droppable({accept:t.dropAccept,onDragEnter:function(i,e){function p(){t.onDragEnter.call(r,l,y)==!1&&(h(e,!1),s.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),s.droppable("disable"),u.disabledNodes.push(a))}var a=n(this).attr("node-id"),c=o(this),v=n(c).treegrid("options"),s=v.finder.getTr(c,null,"highlight"),y=f(e),l=f(this);s.length&&l&&p()},onDragOver:function(i,e){function d(){t.onDragOver.call(r,l,w)==!1&&(h(e,!1),s.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),s.droppable("disable"),u.disabledNodes.push(y))}var y=n(this).attr("node-id"),w,l;if(!(n.inArray(y,u.disabledNodes)>=0)){var p=o(this),k=n(p).treegrid("options"),s=k.finder.getTr(p,null,"highlight");if(s.length&&!v(s)){h(e,!1);return}if(h(e,!0),w=f(e),l=f(this),s.length){var a=e.pageY,c=s.offset().top,b=c+s.outerHeight();s.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom");a>c+(b-c)/2?b-a<5?s.addClass("treegrid-row-bottom"):s.addClass("treegrid-row-append"):a-c<5?s.addClass("treegrid-row-top"):s.addClass("treegrid-row-append");l&&d()}}},onDragLeave:function(i,u){h(u,!1);var e=o(this),c=n(e).treegrid("options"),l=f(u),s=f(this),a=c.finder.getTr(e,n(this).attr("node-id"));a.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom");s&&t.onDragLeave.call(r,s,l)},onDrop:function(i,u){function p(){var r=n(a).treegrid("pop",l[t.idField]),i;c=="append"?(e?(n(s).treegrid("append",{parent:e[t.idField],data:[r]}),e.state=="closed"&&n(s).treegrid("expand",e[t.idField])):n(s).treegrid("append",{parent:null,data:[r]}),n(s).treegrid("enableDnd",l[t.idField])):(i={data:r},c=="top"?i.before=e[t.idField]:i.after=e[t.idField],n(s).treegrid("insert",i),n(s).treegrid("enableDnd",l[t.idField]))}var c="append",e=null,l=f(u),a=o(u),s=o(this),y=n(s).treegrid("options"),h=y.finder.getTr(s,null,"highlight");if(h.length){if(!v(h))return;e=f(h);c=h.hasClass("treegrid-row-append")?"append":h.hasClass("treegrid-row-top")?"top":"bottom";h.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom")}t.onBeforeDrop.call(r,e,l,c)!=!1&&(p.call(this),t.onDrop.call(r,e,l,c))}})})}})})(jQuery);